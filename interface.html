<!doctype html>
<html>
  
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
    <script src="https://bitwiseshiftleft.github.io/sjcl/sjcl.js"></script>
    <script src="scrypt.js"></script>
  </head>
  
  <body ng-app="myApp" ng-controller="myCtrl">
    <div>
      <label>Passphrase:</label>
      <input type="text" ng-model="myPW" placeholder="Put in passphrase">
      <div>KDF is {{dispKDF}}</div>
      <div>ToPASS is {{toPass}}</div>
    </div>
    <div>
      Add a new one:
      <label>Label:</label>
      <input type="text" ng-model="label" placeholder="Site label">
      <label>Password type:</label>
      <select name="kdfsel" ng-model="kdfselect">
	<option value="pbkdf2">PBKDF2</option>
	<option value="scrypt">scrypt</option>
	<!-- Add in customization of kdf -->
      </select>
      <button ng-click="notimpl">Gimmie</button>
    </div>
    <div>
      You are making one for {{label}} of tpe {{kdfselect}}
    </div>
    <div>
      <table>
	<tr ng-repeat="(key, value) in logins">
          <td>{{ key }}</td>
          <td>{{ value.kdf }}</td>
          <td>{{ value.topass}}</td>
          <td><button ng-click="dokdf(value.kdf, value.topass)">GetKDF</button></td>
	</tr>
      </table>
    </div>
    
    <div>
      For export, copy paste:
      <div>
	{{exportForm}}
      </div>
    </div>
    <script>
     var myScript;
     function doPBKDF2(kdfspec, pw) {
       var spec = kdfspec.split(":");
       //spec is pbkdf2:rounds:salt
       return sjcl.misc.pbkdf2(sjcl.codec.utf8String.toBits(pw),
			       sjcl.codec.utf8String.toBits(spec[2]),
			       spec[1], 32*8);
     }
     function doScrypt(kdfspec, pw) {
       var spec = kdfspec.split(":");
       //spec is scrypt:salt:r:N:p
       //note that for javascript, increasing p is best bet since memory is
       //constrained.
       return myScript.crypto_scrypt(myScript.encode_utf8(pw),
				     myScript.encode_utf8(spec[1]),
				     spec[2], spec[3], spec[4], 64);
     }
     function doB64N(passspec, kdfed) {
       var spec = passspec.split(":");
       var numChars = parseInt(spec[1]);
       var b64ed = sjcl.codec.base64.fromBits(kdfed, true, true);
       return b64ed.substring(0, numChars);
       
     }
     var app = angular.module('myApp', []);
     app.controller('myCtrl', function($scope) {
       $scope.dokdf = function(kdfspec, passspec) {
         var spec = kdfspec.split(":");
	 if (spec[0] == "pbkdf2") {
           $scope.compKDF = doPBKDF2(kdfspec, $scope.myPW);
	   $scope.dispKDF = sjcl.codec.hex.fromBits($scope.compKDF);
         } else if (spec[0] == "scrypt") {
	   //We round trip via hex to get into the sjcl format.
	   $scope.compKDF = sjcl.codec.hex.toBits(myScript.to_hex
	     (doScrypt(kdfspec, $scope.myPW)));
	   $scope.dispKDF = sjcl.codec.hex.fromBits($scope.compKDF);
	 } else {
           $scope.compKDF = $scope.myPW + kdfspec;
	 }
	 
	 var pspec = passspec.split(":");
	 if(pspec[0] == "nb64") {
	   $scope.toPass = doB64N(passspec, $scope.compKDF);
	 } else {
	   $scope.toPass = "invalid:" + passspec;
	 }
       }
       $scope.compKDF = "not yet computed";
       //use 32MB
       scrypt_module_factory(on_ready, {requested_total_memory: 32 * 1048576 });

       $scope.logins = {
         "thelogin": {"kdf": "pbkdf2:100:saltysalt", "topass": "nb64:10"},
	 "another": {"kdf": "pbkdf2:100000:asdfasdf", "topass": "nb64:10"},
         "pbkdftestvect": {"kdf": "pbkdf2:2:salt",  "topass": "nb64:10"},
         "scryptlongeryet": {"kdf": "scrypt:SodiumChloride:16384:8:5", "topass":"nb64:10"}
       };
       $scope.exportForm = JSON.stringify($scope.logins);
     });
     function on_ready(scrypt) {
       myScript=scrypt;
     }
    </script>
  </body>
  
</html>
